<h1 align="left">
  <br>
  <img src="./img/hei-en.png" alt="HEI-Vs Logo" width="350">
  <br>
  Industrial Automation Base
  <br>
</h1>

Cours AutB

Author: [Cédric Lenoir](mailto:cedric.lenoir@hevs.ch)

# Bad code generated by an AI.

Le code ci dessous a été généré par une AI. On peut se rendre compte que l'AI a utilisé des pointeurs à la place d'une structure en VAR_IN_OUT.

## Header
```ìecst
FUNCTION_BLOCK FB_PumpOnOffControl
VAR_INPUT
	Enable	: BOOL := TRUE;
    pPump   : POINTER TO DM_Pump;  // Référence à la pompe
END_VAR
VAR_OUTPUT
	Active	: BOOL;
END_VAR

VAR
    nState : E_PumpState := E_PumpState.INIT;  // État initial
    iLoop  : INT;                              // Compteur pour la simulation
END_VAR
```

## Core of the program
```iecst
// Incrémentation du compteur
iLoop := iLoop + 1;

// Activer ou désactiver la gestion en fonction de `Enable`
IF Enable THEN
    // Vérification du statut de la pompe
    IF NOT pPump^.Status THEN
        pPump^.ControlSignal := FALSE;          // Arrêter la pompe
        pPump^.State := 'ERROR';                // Mettre l'état en erreur
        nState := E_PumpState.ERROR;           // Passer en état d'erreur
        RETURN;                                // Arrêter le traitement
    END_IF

    // Machine d'état
    CASE nState OF
        E_PumpState.INIT:  // État initial (arrêté)
            pPump^.ControlSignal := FALSE;      // Désactiver le signal de contrôle
            pPump^.State := 'STOPPED';          // Mettre l'état à "STOPPED"
            IF pPump^.Command THEN              // Si commande ON
                pPump^.ControlSignal := TRUE;   // Activer le signal de contrôle
                pPump^.State := 'RUNNING';      // Mettre l'état à "RUNNING"
                nState := E_PumpState.RUNNING; // Passer à l'état "RUNNING"
            END_IF

        E_PumpState.RUNNING:  // Pompe en marche
            IF NOT pPump^.Command THEN          // Si commande OFF
                pPump^.ControlSignal := FALSE;  // Désactiver le signal de contrôle
                pPump^.State := 'STOPPED';      // Mettre l'état à "STOPPED"
                nState := E_PumpState.INIT;    // Retour à l'état initial
            END_IF

        E_PumpState.ERROR:  // Gestion des erreurs
            pPump^.ControlSignal := FALSE;      // Assurez-vous que la pompe est arrêtée
            IF pPump^.Status THEN               // Si le statut redevient OK
                nState := E_PumpState.INIT;    // Retour à l'état initial
            END_IF
    END_CASE
ELSE
    // Désactiver la gestion et revenir à l'état initial
    nState := E_PumpState.INIT;                // Retour à l'état initial
    pPump^.ControlSignal := FALSE;              // Désactiver le signal de contrôle
    pPump^.State := 'STOPPED';                  // Mettre l'état à "STOPPED"
END_IF

// Mise à jour de l'état actif
Active := Enable;
```

## Call of the Function Block

### Head of the program
```iecst
PROGRAM Main
VAR
    myPump              : DM_Pump; // Instance de la structure
    PtrToMyData         : POINTER TO DM_Pump; // Pointeur vers la structure
    fbPumpOnOffControl  : FB_PumpOnOffControl;
    myCondition         : BOOL;
END_VAR
```

### Core of the program
```iecst
// Obtention d'un pointeur vers la structure
myPump := ADR(myPump);

// Appel de la fonction avec le pointeur
fbPumpOnOffControl(Enable := myCondition,
                   pPump := myPump);

```

<h3 style="color:red">Problem</h3>

Avec un pointeur, vous pourriez écrire le code suivant qui serait accepté par votre compilateur. Ce code conduirait très probablement à un crash du programme, **c'est pourquoi il sera considéré comme une grossière erreur de programmation**.

```iecst
// Obtention d'un pointeur vers la structure
myPump := ADR(myPump);

// Appel de la fonction avec le pointeur
fbPumpOnOffControl(Enable := myCondition);

```